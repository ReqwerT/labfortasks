- name: Shrink C:\ drive and create D:\ exFAT volume
  hosts: win
  gather_facts: no
  tasks:
    - name: Execute disk shrink and create OMV partition
      win_shell: |
        $shrinkSize = 20GB

        # Shrink the C: drive
        $cPart = Get-Partition -DriveLetter C
        Resize-Partition -DriveLetter C -Size ($cPart.Size - $shrinkSize)

        Start-Sleep -Seconds 3

        # Use the unallocated space to create a new partition
        $disk = (Get-Partition -DriveLetter C | Get-Disk)
        $new = New-Partition -DiskNumber $disk.Number -UseMaximumSize -AssignDriveLetter

        # Format and label the new partition
        Format-Volume -DriveLetter $new.DriveLetter -FileSystem exFAT -NewFileSystemLabel "OMV" -Confirm:$false

      args:
        executable: powershell.exe
